data a;
input year rep gen yld;
cards;
1	1	1	7.3
1	1	2	7.716666667
1	1	3	7.008333333
1	1	4	7.975
1	1	5	7.908333333
1	1	6	5.941666667
1	1	7	8.125
1	1	8	7.408333333
1	1	9	8.491666667
1	1	10	6.433333333
1	1	11	8.116666667
1	1	12	7.258333333
1	1	13	6.508333333
1	1	14	6.316666667
1	1	15	6.125
1	1	16	7.066666667
1	1	17	6.416666667
1	1	18	7.65
1	1	19	9.05
1	1	20	7.308333333
1	2	1	8.058333333
1	2	2	9.125
1	2	3	6.65
1	2	4	5.916666667
1	2	5	7.925
1	2	6	8.433333333
1	2	7	8.925
1	2	8	8.25
1	2	9	7.05
1	2	10	6.708333333
1	2	11	7.883333333
1	2	12	7.233333333
1	2	13	5.758333333
1	2	14	7.341666667
1	2	15	6.283333333
1	2	16	7.133333333
1	2	17	6.15
1	2	18	7.575
1	2	19	8.866666667
1	2	20	8.133333333
1	3	1	7.483333333
1	3	2	8.016666667
1	3	3	7.116666667
1	3	4	7.641666667
1	3	5	9.175
1	3	6	8.016666667
1	3	7	6.558333333
1	3	8	8.658333333
1	3	9	8.466666667
1	3	10	6.275
1	3	11	7.625
1	3	12	7.983333333
1	3	13	6.483333333
1	3	14	7.016666667
1	3	15	6.85
1	3	16	7.875
1	3	17	7.425
1	3	18	8.108333333
1	3	19	8.95
1	3	20	8.358333333
2	1	1	5.166666667
2	1	2	2.533333333
2	1	3	5.233333333
2	1	4	2.783333333
2	1	5	4.283333333
2	1	6	3.583333333
2	1	7	5.333333333
2	1	8	5.416666667
2	1	9	5.75
2	1	10	4.9
2	1	11	3.233333333
2	1	12	3
2	1	13	3.633333333
2	1	14	6.716666667
2	1	15	3.416666667
2	1	16	2.95
2	1	17	5.833333333
2	1	18	2.633333333
2	1	19	2.75
2	1	20	3.833333333
2	2	1	5.25
2	2	2	4.833333333
2	2	3	2.5
2	2	4	2.416666667
2	2	5	3.533333333
2	2	6	3.5
2	2	7	3.616666667
2	2	8	4.45
2	2	9	3.433333333
2	2	10	3.083333333
2	2	11	3.25
2	2	12	3.333333333
2	2	13	5.166666667
2	2	14	3.833333333
2	2	15	3.633333333
2	2	16	3.3
2	2	17	4.416666667
2	2	18	4.583333333
2	2	19	3.333333333
2	2	20	3.733333333
2	3	1	4.65
2	3	2	4.416666667
2	3	3	4.45
2	3	4	2.833333333
2	3	5	2.583333333
2	3	6	3.333333333
2	3	7	4.283333333
2	3	8	4.833333333
2	3	9	5.633333333
2	3	10	3.2
2	3	11	5.5
2	3	12	6.95
2	3	13	4.75
2	3	14	3.75
2	3	15	5.616666667
2	3	16	5.65
2	3	17	6.083333333
2	3	18	6.283333333
2	3	19	6.5
2	3	20	3.05
;
proc glm   outstat=aa ;
class yld;
by year;
class gen rep;
model yld= gen rep/ss3;
run;
data aa;
set aa;
drop  _SOURCE_   _NAME_  _TYPE_    F         PROB;
if 'gen'=_SOURCE_ | 'rep'=_SOURCE_  then delete;
mse=ss/df;
logmse=log(mse);
dflogmse=df*logmse;
iversdf=1/df;
ivemse=1/mse;
run;
proc print;
proc iml;
use aa ;
read all into zz;
e=nrow(zz);
varname={ env DF SS  mse logmse dflogmse iversdf invmse};
sum=zz[ +,{1 2 3 4 5 6 7 8 }];
c=1+((1/(3*(e-1)))*((sum[7])-1/sum[2]));
sspold=sum[3]/sum[2];
tssp=log(sspold)*sum[2];
chisq=(1/c)*(tssp-sum[6]);
prob=1-probchi(chisq,e-1);
PRINT chisq PROB;
run;
